<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistema de Notas — Versión CSS (linked)</title>
  <link rel="stylesheet" href="SistemaNotas_v2.css">
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Sistema de Notas — CSS Clean</h1>
        <p class="lead small">Inicia sesión para administrar notas. Demo local — no para datos sensibles.</p>
      </div>
      <div class="small muted">Hecho rápido y sin drama</div>
    </header>

    <div class="grid">
      <!-- LOGIN / INFO -->
      <aside>
        <div class="card login-box" id="loginCard">
          <h3>Acceso</h3>
          <p class="muted">Usuario por defecto: <strong>admin</strong> / Clave: <strong>1234</strong></p>
          <label for="u">Usuario</label>
          <input id="u" type="text" placeholder="usuario" />
          <label for="p">Contraseña</label>
          <input id="p" type="password" placeholder="contraseña" />
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn btn-primary" id="loginBtn">Entrar</button>
            <button class="btn btn-danger" id="clearBtn">Borrar datos</button>
          </div>
          <p id="msg" class="small muted" style="margin-top:8px"></p>
        </div>

        <div style="height:12px"></div>
        <div class="card small muted">
          <strong>Notas:</strong>
          <ul style="margin-top:8px; margin-left:18px">
            <li>Las notas se guardan en tu navegador (localStorage).</li>
            <li>Nota mínima permitida: <strong>2</strong>.</li>
            <li>Exporta/Importa CSV desde el panel cuando inicies sesión.</li>
          </ul>
        </div>
      </aside>

      <!-- APP -->
      <main>
        <div class="card" id="appCard" style="display:none">
          <div class="panel-head">
            <div>
              <h3 style="margin:0">Panel de Notas</h3>
              <div class="small muted">Tabla horizontal — click en celdas para editar.</div>
            </div>
            <div class="controls">
              <button class="btn" id="addCol">+ Alumno</button>
              <button class="btn" id="addRow">+ Materia</button>
              <label style="display:inline-flex;align-items:center;gap:8px;padding-left:6px"><input id="csvFile" type="file" accept="text/csv" style="display:none"/><span class="btn">Importar CSV</span></label>
              <button class="btn" id="exportCSV">Exportar CSV</button>
              <button class="btn" id="logout">Cerrar sesión</button>
            </div>
          </div>

          <div class="table-wrap">
            <table id="grades">
              <thead id="thead"></thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>

          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
            <div class="small muted">Validación: decimales permitidos. Mínimo 2.</div>
            <div>
              <button class="btn btn-primary" id="saveBtn">Guardar</button>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script>
    // Keys
    const KEY = 'notas_v2_data';
    const CRED = 'notas_v2_cred';

    // Estado por defecto
    let state = { students: ['Raúl','Aurora'], rows: [{name:'Parcial 1', grades:[8.5,9.0]},{name:'Parcial 2', grades:[7.5,8.0]}] };

    // Elementos
    const loginCard = document.getElementById('loginCard');
    const appCard = document.getElementById('appCard');
    const msg = document.getElementById('msg');

    // Helpers
    function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }
    function load(){ const x=localStorage.getItem(KEY); if(x) try{state=JSON.parse(x)}catch(e){} }
    function loadCred(){ const x=localStorage.getItem(CRED); if(x) return JSON.parse(x); const d={user:'admin',pass:'1234'}; localStorage.setItem(CRED,JSON.stringify(d)); return d }

    // Render tabla
    function render(){
      const thead = document.getElementById('thead'); const tbody = document.getElementById('tbody');
      thead.innerHTML=''; tbody.innerHTML='';
      const tr = document.createElement('tr'); tr.innerHTML = `<th>Materia / Actividad</th>` + state.students.map(s=>`<th>${escape(s)}</th>`).join(''); thead.appendChild(tr);
      state.rows.forEach((r,ri)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td contenteditable="true" data-row="${ri}" data-col="-1">${escape(r.name)}</td>` + r.grades.map((g,ci)=>`<td contenteditable="true" data-row="${ri}" data-col="${ci}">${g}</td>`).join('');
        tbody.appendChild(tr);
      });
      // listeners
      document.querySelectorAll('[contenteditable=true]').forEach(cell=>cell.addEventListener('blur',onBlur));
    }

    function onBlur(e){
      const el=e.target; const r=parseInt(el.dataset.row,10); const c=parseInt(el.dataset.col,10); const val=el.textContent.trim();
      if(c===-1){ state.rows[r].name = val||'Sin nombre'; save(); return; }
      if(val===''){ state.rows[r].grades[c]=''; save(); return; }
      const num = Number(val.replace(',','.'));
      if(isNaN(num)){ alert('Valor no numérico'); return; }
      if(num < 2){ alert('La nota debe ser al menos 2'); return; }
      state.rows[r].grades[c] = Math.round(num*100)/100; save(); render();
    }

    // Eventos login
    document.getElementById('loginBtn').addEventListener('click',()=>{
      const u=document.getElementById('u').value.trim(); const p=document.getElementById('p').value;
      const cred = loadCred();
      if(u===cred.user && p===cred.pass){ msg.textContent='Acceso correcto.'; showApp(); } else { msg.textContent='Usuario/clave incorrectos'; }
    });

    document.getElementById('clearBtn').addEventListener('click',()=>{ if(confirm('Borrar datos guardados?')){ localStorage.removeItem(KEY); localStorage.removeItem(CRED); location.reload(); } });

    function showApp(){ loginCard.style.display='none'; appCard.style.display='block'; load(); render(); }

    document.getElementById('logout').addEventListener('click',()=>{ location.reload(); });

    // Add alumno / materia
    document.getElementById('addCol').addEventListener('click',()=>{ const name = prompt('Nombre del alumno:','Nuevo'); if(!name) return; state.students.push(name); state.rows.forEach(r=>r.grades.push('')); save(); render(); });
    document.getElementById('addRow').addEventListener('click',()=>{ const name = prompt('Nombre materia/actividad:','Actividad'); if(!name) return; state.rows.push({name,grades:state.students.map(()=>'' )}); save(); render(); });

    // CSV import/export
    document.querySelector('label span').addEventListener('click',()=>document.getElementById('csvFile').click());
    document.getElementById('csvFile').addEventListener('change',async (ev)=>{ const f=ev.target.files[0]; if(!f) return; const txt=await f.text(); parseCSV(txt); ev.target.value=''; });

    function parseCSV(text){ const lines=text.split(/\r?\n/).filter(Boolean); if(lines.length<2){ alert('CSV inválido'); return; } const hdr=lines[0].split(',').map(s=>s.trim()); const students=hdr.slice(1); const rows=lines.slice(1).map(l=>{ const parts=l.split(',').map(p=>p.trim()); return {name:parts[0]||'Sin nombre', grades: students.map((_,i)=>{ const v=parts[i+1]; if(!v) return ''; const n=Number(v.replace(',','.')); return isNaN(n)?v:n; }) }; }); state.students = students.length?students:state.students; state.rows = rows.length?rows:state.rows; save(); render(); alert('CSV importado'); }

    document.getElementById('exportCSV').addEventListener('click',()=>{ const h=['Materia'].concat(state.students).join(',')+'\n'; const b = state.rows.map(r=> [r.name].concat(r.grades.map(g=>g===undefined?'':g)).join(',')).join('\n'); const csv=h+b; const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='notas_export.csv'; a.click(); URL.revokeObjectURL(url); });

    document.getElementById('saveBtn').addEventListener('click',()=>{ // validación final
      for(const r of state.rows){ for(const g of r.grades){ if(g===''||g===null) continue; const n=Number(g); if(isNaN(n)||n<2){ alert('Hay notas inválidas (vacías o <2). Revisa.'); return; } } } save(); alert('Guardado.'); });

    function escape(str){ return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // iniciar en modo login
  </script>
</body>
</html>
