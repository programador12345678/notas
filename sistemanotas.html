<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Notas</title>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://TU-PROJECT-URL.supabase.co";  // Cambia esto
  const SUPABASE_KEY = "TU-CLAVE-ANON-PUBLICA";               // Cambia esto
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
</script>

<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; text-align:center; background:#f2f2f2; }
header { background:#b22222; color:white; padding:10px; display:flex; justify-content:space-between; align-items:center; }
.card { background:white; width:90%; max-width:400px; margin:80px auto; padding:20px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.2); }
input { width:90%; padding:8px; margin:8px 0; }
button { padding:8px 12px; margin:8px; border:none; border-radius:5px; cursor:pointer; }
button:hover { opacity:0.8; }
.guardar-btn { background:#b22222; color:white; }
.cerrar-btn { background:#1e90ff; color:white; }
table { margin:20px auto; border-collapse:collapse; width:95%; max-width:800px; background:white; }
th,td { border:1px solid #ccc; padding:8px; text-align:center; }
th { background:#1e90ff; color:white; }
tfoot td { font-weight:bold; background:#eee; }
.hidden { display:none; }
footer { margin-top:20px; color:#555; }
@media(max-width:600px){
  th,td { font-size:12px; padding:5px; }
  button { padding:6px 10px; }
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login" class="card">
  <h2>Sistema de Notas</h2>
  <input type="text" id="usuario" placeholder="Usuario">
  <input type="password" id="contrasena" placeholder="Contraseña">
  <button id="login-btn">Entrar</button>
  <p id="error-msg" style="color:red"></p>
</div>

<!-- SISTEMA DE NOTAS -->
<div id="sistema" class="hidden">
  <header>
    <h1>Sistema de Notas</h1>
    <button id="logout" class="cerrar-btn">Cerrar sesión</button>
  </header>

  <p id="saludo" style="color:#b22222; font-weight:bold;"></p>

  <section>
    <table id="tabla">
      <thead>
        <tr>
          <th>Materia</th>
          <th>Cotidiana</th>
          <th>Integradora</th>
          <th>Examen</th>
          <th>Nota Final</th>
        </tr>
      </thead>
      <tbody>
        <tr><td>Lenguaje</td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td></td></tr>
        <tr><td>Matemáticas</td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td></td></tr>
        <tr><td>Estudios Sociales</td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td></td></tr>
        <tr><td>Inglés</td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td></td></tr>
        <tr><td>Informática</td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td></td></tr>
        <tr><td>Orientación Para La Vida</td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td></td></tr>
        <tr><td>Reading and Writing</td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td></td></tr>
        <tr><td>Educación Física</td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td></td></tr>
        <tr><td>Seminario</td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td></td></tr>
        <tr><td>Conversation</td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td></td></tr>
        <tr><td>Moral Urbanidad y Cívica</td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td></td></tr>
        <tr><td>Física Química</td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td></td></tr>
        <tr><td>Biología</td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td></td></tr>
      </tbody>
      <tfoot>
        <tr>
          <td colspan="4">Promedio General</td>
          <td id="promedio"></td>
        </tr>
      </tfoot>
    </table>

    <button id="guardar-btn" class="guardar-btn">Guardar resultados</button>
  </section>

  <footer>© 2025 Sistema de Notas</footer>
</div>

<script>
// Usuarios fijos
const usuarios = { "JFlores":"Notassv25", "20210012":"CCSA20" };
let usuarioActual = "";

// LOGIN
const loginDiv = document.getElementById("login");
const sistemaDiv = document.getElementById("sistema");
const loginBtn = document.getElementById("login-btn");
const logoutBtn = document.getElementById("logout");
const errorMsg = document.getElementById("error-msg");
const saludo = document.getElementById("saludo");

loginBtn.addEventListener("click", async () => {
  const user = document.getElementById("usuario").value;
  const pass = document.getElementById("contrasena").value;

  if(usuarios[user] && usuarios[user]===pass){
    usuarioActual=user;
    loginDiv.classList.add("hidden");
    sistemaDiv.classList.remove("hidden");
    saludo.textContent = `Hola, ${usuarioActual}`;
    setTimeout(()=>{ saludo.textContent = ""; },10000);

    // Permisos
    const filas = document.querySelectorAll("#tabla tbody tr td[contenteditable]");
    if(usuarioActual==="JFlores"){
      filas.forEach(td=>td.contentEditable=true);
      document.getElementById("guardar-btn").style.display="inline-block";
    } else {
      filas.forEach(td=>td.contentEditable=false);
      document.getElementById("guardar-btn").style.display="none";
    }

    cargarDatos();
  } else {
    errorMsg.textContent="Usuario o contraseña incorrectos.";
  }
});

// LOGOUT
logoutBtn.addEventListener("click", ()=>{
  loginDiv.classList.remove("hidden");
  sistemaDiv.classList.add("hidden");
});

// GUARDAR DATOS
async function guardarDatos(){
  const filas=document.querySelectorAll("#tabla tbody tr");
  let datos=[];
  let sumaProm=0;
  let count=0;

  filas.forEach(fila=>{
    const celdas=fila.querySelectorAll("td");
    const materia=celdas[0].textContent.trim();
    const cot=parseFloat(celdas[1].textContent)||0;
    const int=parseFloat(celdas[2].textContent)||0;
    const exa=parseFloat(celdas[3].textContent)||0;
    const notaFinal=(cot*0.35 + int*0.35 + exa*0.3).toFixed(2);
    celdas[4].textContent=notaFinal;
    sumaProm+=parseFloat(notaFinal);
    count++;

    datos.push({ usuario:usuarioActual, materia, cotidiana:cot, integradora:int, examen:exa, nota_final:notaFinal });
  });

  const promedioGeneral=(sumaProm/count).toFixed(2);
  document.getElementById("promedio").textContent=promedioGeneral;

  // Guardar en Supabase
  await supabase.from("notas").delete().eq("usuario",usuarioActual);
  const { error }=await supabase.from("notas").insert(datos);
  if(error) alert("Error al guardar: "+error.message);
  else alert("Notas guardadas correctamente");
}

// CARGAR DATOS
async function cargarDatos(){
  const { data,error } = await supabase.from("notas").select("*").eq("usuario","JFlores");
  if(error){ console.log(error); return; }
  const filas=document.querySelectorAll("#tabla tbody tr");
  let sumaProm=0;
  let count=0;

  filas.forEach((fila,i)=>{
    const registro=data[i];
    if(registro){
      const celdas=fila.querySelectorAll("td");
      celdas[1].textContent=registro.cotidiana;
      celdas[2].textContent=registro.integradora;
      celdas[3].textContent=registro.examen;
      celdas[4].textContent=registro.nota_final;
      sumaProm+=parseFloat(registro.nota_final);
      count++;
    }
  });

  const promedioGeneral=(count>0)?(sumaProm/count).toFixed(2):"";
  document.getElementById("promedio").textContent=promedioGeneral;
}

// EVENTO BOTON GUARDAR
document.getElementById("guardar-btn").addEventListener("click",guardarDatos);
</script>

</body>
</html>

